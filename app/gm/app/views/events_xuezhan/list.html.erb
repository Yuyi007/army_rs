<%= render 'shared/grant' %>
<h3><span class="label label-default"><%=t :choose_zone%></span></h3>
<%= render 'shared/zones' %>
<br/>
<a href="#" onclick="toCreate()" class="btn btn-info"><%=t :create_xuezhan_event%></a>
<br/><br/>
<table id='eventstable' class='table table-striped table-bordered table-hover'>
  <tr>
    <th><%=t :id %></th>
    <th><%=t :zone %></th>
    <th><%=t :open_date%></th>
    <th><%=t :close_date%></th>
   <th><%=t :rewardTids %></th>
    <th><%=t :event_type %></th>
    <th><%=t :actions %></th>
  </tr>
  <% @list.each do |n| %>
  <tr>
    <td><%=n.id%></td>
    <td><%=n.zone%></td>
    <td><%=n.startTime%></td>
    <td><%=n.endTime%></td>
    <td>
    <%= simple_format(n.rewardTids.map{|x| getRewardName(x)}.join("\n")) rescue '' %>
    </td>
    <th><%=t n.event_type %></th>
    <td>
      <%= link_to(:edit, {:action => :edit, :id => n.id, :zone => n.zone}, {:method => :get}) %>
      <%= link_to(:delete, {:action => :delete_xuezhan, :id => n.id, :zone => n.zone}, {:method => :post, :data => {:confirm => t(:are_you_sure_to_delete)}}) %>
    </td>
  </tr>
  <% end %>

</table>
<form id="copyForm" action="'events_xuezhan/copy_xuezhan/1/copy_list'" method="POST" class="form">
  <div class="alert alert-success">
    <%=t :copy_current_config_to_zone%>,
    <%=t :confirm_your_config_saved%>,
    <%=t :enter_zone_split_with_space_like%>2 3 6
  </div>
  <%= text_field_tag "copy_zones", nil, :size => 100, :placeholder => "2 3 6", :class => "form-control" %>
  <br/>
  <span><%=t :force_copy%></span>
  <%= check_box_tag 'enable_force_copy' %>
  <input type="button" onclick="copy()" value="<%=t :copy_current_config_to_zone%>" class="btn btn-success">
</form>
<script type="text/javascript">
  /////////////////////////////////////////////
  // common
  //

  $("#zone").change(onZoneChange);

  function onZoneChange()
  {
    var zoneIndex = $("#zone").val();
    console.log("zone=" + zoneIndex);
    getEvents(zoneIndex);
  }

  function getEvents(zone) {
    var zoneIndex = $("#zone").val();
    window.location.href = "/events_xuezhan/list?zone=" + zoneIndex;
  }

  function toCreate(){
    var zoneIndex = $("#zone").val();
    window.location.href = "/events_xuezhan/new?zone=" + zoneIndex;
  }

  function copy()
  {
    if($("#enable_force_copy").prop('checked'))
    {
      if(confirm("<%=t :force_copy_tips%>"))
      {
        copyxuezhanEvents();
      }
      else
      {
        //
      }
    }
    else
    {
      copyxuezhanEvents();
    }
  }

  function copyxuezhanEvents()
  {
    var zoneIndex = $("#zone").val();
    $.ajax({
      type: 'POST',
      url: '/events_xuezhan/' + zoneIndex + "/copy_list",
      data: {
              "tozones":$("#copy_zones").val(),
              "force_copy":$("#enable_force_copy").prop('checked')
            }
    }).done(function(json){
      if(json && json['success'])
      {
        showStatus('copys success~', 'green')
      }
      else if(json)
      {
        //showStatus('copys error, reason: ' + json['reason'], 'red')
        showStatus(parseError(json), 'red')
      }
      else
      {
        showStatus('copys error', 'red')
      }
      }).fail(function(xhr, status){
      showStatus('Something wrong!', 'red');
    });
  }

  function deleteCur(zone, id)
  {
    if(confirm("<%=t :confirm_operation%>"))
    {
      deletexuezhanEvent(zone, id);
    }
    else
    {
      //
    }
  }

  function deletexuezhanEvent(zone, id)
  {
    $.ajax({
      type: 'POST',
      url: '/events_xuezhan/delete/' + zone + "/" + id
    }).done(function(json){
      if(json && json['success'])
      {
        showStatus('delete success~', 'green')
        onZoneChange()
      }
      else
      {
        showStatus('delete error', 'red')
      }
      }).fail(function(xhr, status){
      showStatus('Something wrong!', 'red');
    });
  }
</script>
